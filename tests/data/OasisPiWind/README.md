# OasisPiWind

Perform the area peril and vulnerability lookup for PiWind example model. This will serve as an exemplar for creating look-up service for other models, and should encapculate best practices.

## Cloning the repository

To clone this repository first ensure that you have generated an SSH key pair on your local machine and add the public key of that pair to your GitHub account (there is a GitHub guide for this at https://help.github.com/articles/connecting-to-github-with-ssh/). Then run

    git clone --recursive git+ssh://git@github.com/OasisLMF/OasisPiWind

The `--recursive` option ensures the cloned repository contains the necessary Oasis repositories <a href="https://github.com/OasisLMF/oasis_utils" target="_blank">`oasis_utils`</a>, <a href="https://github.com/OasisLMF/oasis_keys_lookup" target="_blank">`oasis_keys_lookup`</a>, <a href="https://github.com/OasisLMF/oasis_keys_server" target="_blank">`oasis_keys_server`</a> and <a href="https://github.com/OasisLMF/oasis_build_utils" target="_blank">`oasis_build_utils`</a> as Git submodules. You have read only access to these repositories.

If you've already cloned the repository and wish to update the submodules from GitHub then run

    git submodule foreach 'git pull origin master'

## Request Format

The request is in CSV format, and can be compressed or uncompressed.

For CSV set the Content-Type header to 'text/csv; charset=utf-8'.

For zipped date set Content-Encoding header to 'gzip'.

### CSV
```
ID,LAT,LON,COVERAGE,CLASS_1,CLASS_2
1,0.5,0.5,1,A,B
2,1.5,0.5,1,A,B
```

### JSON
```
[
  {
    "id": 1,
    "lat": 0.5, 
    "lon": 0.5, 
    "coverage": 1, 
    "class_1": "A", 
    "class_2": "B", 
  },
    {
    "id": 2,
    "lat": 0.5, 
    "lon": 0.5, 
    "coverage": 1, 
    "class_1": "A", 
    "class_2": "B", 
  }
}
```

## Response format

The response is in JSON format, and can be compressed or uncompressed.
```javascript
{
  "status": "success",
  "items": {
    "id": 1,
    "coverage": 1, 
    "status": "success", 
    "area_peril_id": 1, 
    "vulnerability_id": 1
  },
    {
    "id": 2,
    "coverage": 10, 
    "status": "nomatch", 
    "area_peril_id": 1, 
    "vulnerability_id": None,
    "message": "No area peril or vulnerability match."
  }
  {
    "id": 3,
    "coverage": 1, 
    "status": "fail", 
    "area_peril_id": None, 
    "vulnerability_id": 1,
    "message": "Invalid lat/lon."
  }
}
```
## Lookup Data
The lookup data is created using the PiWind output generated using the code in the [OasisImplementationModels](https://github.com/OasisLMF/OasisImplementationModels.git) repo. The area peril data was converted to be  the corners of the grid squares rather than a centroid point.

The lookup data can also be generated by running the `client/CreateData.py` script - this will generate area peril and vulnerability lookup csv files in the `client` subdirectory.


## Example Client Code

TO BE UPDATED

## Manual installation

TO BE UPDATED

### Installation requirements

Installation will be via a Docker app running on an AWS instance - the app image will contain all the requirements. The internal requirements are:

* Python 2.7.x
* Pandas 0.19.2
* Flask 0.10.1
* Shapely 1.5.13
* PyODBC 3.0.10

### Deployment

Deployment will be via a Docker app running on an AWS instance.

## Installation script

TO BE UPDATED

## Server test

TO BE UPDATED
